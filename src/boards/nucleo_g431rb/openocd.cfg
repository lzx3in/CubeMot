# OpenOCD Configuration for NUCLEO-G431RB Board
# Compatible with ST-Link debuggers

#=============================================================================#
# Interface Configuration
#=============================================================================#
source [find interface/stlink.cfg]
transport select hla_swd

#=============================================================================#
# Target Configuration
#=============================================================================#
source [find target/stm32g4x.cfg]

#=============================================================================#
# Debug and Reset Configuration
#=============================================================================#
reset_config srst_only
adapter speed 4000

#=============================================================================#
# Memory Configuration
#=============================================================================#
set WORKAREASIZE 0x2000

#=============================================================================#
# Optional GDB Event Handlers (uncomment to use)
#=============================================================================#
# $_TARGETNAME configure -event gdb-attach {
#     echo "Halting target..."
#     halt
# }
# 
# $_TARGETNAME configure -event reset-init {
#     echo "Resetting and halting target..."
#     halt
# }
# 
# $_TARGETNAME configure -event gdb-detach {
#     echo "Resuming target..."
#     resume
# }

#=============================================================================#
# Advanced Features (uncomment as needed)
#=============================================================================#

# RTOS support
# $_TARGETNAME configure -rtos auto

# Flash protection (use with caution)
# proc disable_write_protection {} {
#     echo "Disabling write protection..."
#     mmw 0x40022008 0x00000001 0x00000000
#     mmw 0x40022008 0x00000002 0x00000000
#     mmw 0x40022014 0x0000FFFF 0x00000000
#     mmw 0x40022018 0x00000002 0x00000000
#     wait_on_bsy
# }

# External Flash (example)
# flash bank external_flash spi 0x90000000 0x1000000 0 0 $_TARGETNAME

#=============================================================================#
# Utility Commands
#=============================================================================#
proc target_info {} {
    echo "Target information:"
    reg
    echo ""
    echo "Flash info:"
    flash list
}

proc mass_erase {} {
    echo "Executing mass erase..."
    flash erase_sector 0 0 63
    echo "Mass erase complete"
}
