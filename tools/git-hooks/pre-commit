#!/bin/bash

set -e

if ! command -v git-clang-format &> /dev/null; then
    echo "Error: git-clang-format not found. Please install clang-format." >&2
    exit 1
fi

echo "Checking code format for staged file(s)..."

# Note: git-clang-format does not support .clang-format-ignore.
# To exclude specific directories from formatting, create a .clang-format file
# in those directories with the following content:
#     DisableFormat: true

output=$(git clang-format --staged --diff --style=file --extensions c,h,cpp,hpp,cc,cxx,c++,h++,hh 2>&1 || true)

if echo "$output" | grep -q "diff --git"; then
    echo "❌ Code format check failed! The following files require formatting:" >&2
    echo "$output" >&2
    echo "" >&2
    echo "Run this command to fix:" >&2
    echo "    git clang-format --staged --style=file --extensions c,h,cpp,hpp,cc,cxx,c++,h++,hh" >&2
    exit 1
fi

echo "✅ Code format check passed."
